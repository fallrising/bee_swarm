# 環境準備指南

## 系統要求

### 硬件要求
- **CPU**: 2核以上
- **內存**: 4GB 以上
- **存儲**: 20GB 可用空間
- **網絡**: 穩定的互聯網連接

### 軟件要求
- **操作系統**: Ubuntu 20.04+ / CentOS 7+ / macOS 10.15+
- **Docker**: 20.10+
- **Docker Compose**: 1.29+
- **Git**: 2.25+
- **Python**: 3.8+ (用於模擬工具)

## 環境準備步驟

### 1. 基礎環境安裝

#### Ubuntu/Debian
```bash
# 更新系統
sudo apt update && sudo apt upgrade -y

# 安裝必要工具
sudo apt install -y git curl wget vim

# 安裝 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# 安裝 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

#### CentOS/RHEL
```bash
# 更新系統
sudo yum update -y

# 安裝必要工具
sudo yum install -y git curl wget vim

# 安裝 Docker
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install -y docker-ce docker-ce-cli containerd.io
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -aG docker $USER

# 安裝 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 2. 項目環境準備

```bash
# 創建項目目錄
mkdir -p /opt/bee-swarm
cd /opt/bee-swarm

# 克隆項目
git clone https://github.com/fallrising/bee_swarm.git .

# 設置環境變量
cp .env.example .env
vim .env  # 編輯配置文件
```

### 3. Python 環境準備（模擬工具）

```bash
# 安裝 Python 3.8+
sudo apt install -y python3 python3-pip python3-venv

# 創建虛擬環境
python3 -m venv venv
source venv/bin/activate

# 安裝依賴
pip install -r docs/05-simulation/scripts/requirements.txt
```

### 4. 驗證安裝

```bash
# 驗證 Docker
docker --version
docker-compose --version

# 驗證 Git
git --version

# 驗證 Python 環境
python3 --version
pip3 --version

# 運行基礎測試
"docs/05-simulation/scripts/basic_simulation.py"
```

## 網絡配置

### 防火牆設置
```bash
# Ubuntu UFW
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable

# CentOS firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### DNS 配置
```bash
# 配置可靠的 DNS
echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf
```

## 安全配置

### SSH 安全設置
```bash
# 生成 SSH 密鑰對
ssh-keygen -t rsa -b 4096 -C "bee-swarm@your-domain.com"

# 配置 SSH
sudo vim /etc/ssh/sshd_config
# 修改以下設置：
# Port 2222                    # 更改默認端口
# PermitRootLogin no          # 禁止 root 登錄
# PasswordAuthentication no   # 禁用密碼認證
# PubkeyAuthentication yes    # 啟用公鑰認證

# 重啟 SSH 服務
sudo systemctl restart sshd
```

### 系統安全
```bash
# 安裝 fail2ban
sudo apt install -y fail2ban

# 配置 fail2ban
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo vim /etc/fail2ban/jail.local

# 啟動服務
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

## 監控設置

### 基礎監控
```bash
# 安裝 htop 和 iotop
sudo apt install -y htop iotop netstat-nat

# 設置日誌監控
sudo vim /etc/rsyslog.conf
sudo systemctl restart rsyslog
```

### Docker 監控
```bash
# 安裝 Docker 監控工具
docker run -d --name=netdata \
  -p 19999:19999 \
  -v netdataconfig:/etc/netdata \
  -v netdatalib:/var/lib/netdata \
  -v netdatacache:/var/cache/netdata \
  -v /etc/passwd:/host/etc/passwd:ro \
  -v /etc/group:/host/etc/group:ro \
  -v /proc:/host/proc:ro \
  -v /sys:/host/sys:ro \
  -v /etc/os-release:/host/etc/os-release:ro \
  --restart unless-stopped \
  --cap-add SYS_PTRACE \
  --security-opt apparmor=unconfined \
  netdata/netdata
```

## 備份策略

### 自動備份腳本
```bash
#!/bin/bash
# backup-bee-swarm.sh

BACKUP_DIR="/opt/backups/bee-swarm"
DATE=$(date +%Y%m%d_%H%M%S)
PROJECT_DIR="/opt/bee-swarm"

# 創建備份目錄
mkdir -p $BACKUP_DIR

# 備份項目文件
tar -czf $BACKUP_DIR/bee-swarm-$DATE.tar.gz -C $PROJECT_DIR .

# 清理舊備份（保留30天）
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "備份完成: $BACKUP_DIR/bee-swarm-$DATE.tar.gz"
```

### 設置定時備份
```bash
# 添加 crontab
crontab -e

# 每天凌晨2點自動備份
0 2 * * * /opt/scripts/backup-bee-swarm.sh >> /var/log/bee-swarm-backup.log 2>&1
```

## 故障排除

### 常見問題

#### Docker 權限問題
```bash
# 解決 Docker 權限問題
sudo usermod -aG docker $USER
newgrp docker

# 或者重新登錄系統
logout
```

#### 端口衝突
```bash
# 檢查端口佔用
sudo netstat -tulpn | grep :80
sudo lsof -i :80

# 停止衝突服務
sudo systemctl stop apache2  # 或 nginx
```

#### 磁盤空間不足
```bash
# 清理 Docker 資源
docker system prune -af

# 清理日誌文件
sudo journalctl --vacuum-time=7d
```

### 性能優化

#### 系統優化
```bash
# 調整檔案描述符限制
echo "* soft nofile 65535" | sudo tee -a /etc/security/limits.conf
echo "* hard nofile 65535" | sudo tee -a /etc/security/limits.conf

# 調整內核參數
echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf
echo "net.core.somaxconn=65535" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

#### Docker 優化
```bash
# 配置 Docker daemon
sudo vim /etc/docker/daemon.json
{
  "storage-driver": "overlay2",
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}

# 重啟 Docker
sudo systemctl restart docker
``` 