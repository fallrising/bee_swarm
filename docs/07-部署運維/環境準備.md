# 環境準備

## 概述

本章節詳細說明了 Bee Swarm 項目的環境準備要求，包括開發環境、測試環境和生產環境的配置指南。

## 目錄

- [基礎環境要求](#基礎環境要求)
- [開發環境配置](#開發環境配置)
- [測試環境配置](#測試環境配置)
- [生產環境配置](#生產環境配置)
- [環境變數配置](#環境變數配置)
- [依賴項管理](#依賴項管理)
- [網路與安全配置](#網路與安全配置)
- [環境驗證](#環境驗證)

## 基礎環境要求

### 硬體要求

#### 最低配置
- **CPU**: 雙核心 2.0GHz
- **記憶體**: 4GB RAM
- **儲存空間**: 20GB 可用空間
- **網路**: 穩定的網際網路連線

#### 建議配置
- **CPU**: 四核心 3.0GHz 或更高
- **記憶體**: 8GB RAM 或更高
- **儲存空間**: 50GB SSD
- **網路**: 高速寬頻連線

#### 生產環境配置
- **CPU**: 8核心 3.5GHz
- **記憶體**: 16GB RAM
- **儲存空間**: 100GB SSD
- **網路**: 冗餘網路連線
- **備份**: 自動備份解決方案

### 軟體要求

#### 作業系統支援
- **Linux**: Ubuntu 20.04 LTS 或更高版本（推薦）
- **macOS**: 10.15 或更高版本
- **Windows**: Windows 10 或更高版本

#### 核心軟體
```bash
# Python
Python 3.8+ (推薦 3.9+)

# Node.js (如果需要前端開發)
Node.js 16.x+ (推薦 18.x)
npm 8.x+ 或 yarn 1.22+

# Git
Git 2.25+

# Docker
Docker 20.10+
Docker Compose 2.0+

# 可選工具
kubectl 1.22+ (Kubernetes 部署)
terraform 1.0+ (基礎設施即代碼)
```

## 開發環境配置

### Python 環境設置

#### 1. 安裝 Python
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3.9 python3.9-pip python3.9-venv

# macOS (使用 Homebrew)
brew install python@3.9

# Windows
# 下載並安裝 Python 3.9+ from python.org
```

#### 2. 建立虛擬環境
```bash
# 建立專案目錄
mkdir bee-swarm-dev
cd bee-swarm-dev

# 建立虛擬環境
python3 -m venv venv

# 啟動虛擬環境
# Linux/macOS:
source venv/bin/activate

# Windows:
venv\Scripts\activate
```

#### 3. 安裝依賴項
```bash
# 複製專案
git clone https://github.com/your-org/bee-swarm.git
cd bee-swarm

# 安裝 Python 依賴項
pip install -r requirements.txt

# 安裝開發依賴項
pip install -r requirements-dev.txt
```

### IDE 配置

#### VS Code 設置
```json
{
  "python.defaultInterpreterPath": "./venv/bin/python",
  "python.linting.enabled": true,
  "python.linting.pylintEnabled": true,
  "python.formatting.provider": "black",
  "python.sortImports.args": ["--profile", "black"],
  "files.exclude": {
    "**/__pycache__": true,
    "**/.pytest_cache": true,
    "**/.coverage": true
  },
  "python.testing.pytestEnabled": true,
  "python.testing.unittestEnabled": false
}
```

#### 推薦擴展
```bash
# VS Code 擴展
code --install-extension ms-python.python
code --install-extension ms-python.black-formatter
code --install-extension ms-python.isort
code --install-extension ms-vscode.vscode-json
code --install-extension redhat.vscode-yaml
code --install-extension ms-vscode.vscode-git
```

### Docker 開發環境

#### Dockerfile.dev
```dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安裝系統依賴項
RUN apt-get update && apt-get install -y \
    git \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# 複製並安裝 Python 依賴項
COPY requirements*.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# 複製專案代碼
COPY . .

# 設置環境變數
ENV PYTHONPATH=/app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# 暴露端口
EXPOSE 8000

# 開發模式啟動
CMD ["python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
```

#### docker-compose.dev.yml
```yaml
version: '3.8'

services:
  bee-swarm-api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - .:/app
      - /app/__pycache__
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
    depends_on:
      - redis
      - postgres

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"

  postgres:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: bee_swarm_dev
      POSTGRES_USER: dev_user
      POSTGRES_PASSWORD: dev_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

## 測試環境配置

### 單元測試環境
```bash
# 安裝測試依賴項
pip install pytest pytest-cov pytest-mock pytest-asyncio

# 建立測試配置
cat > pytest.ini << EOF
[tool:pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = 
    --cov=bee_swarm
    --cov-report=html
    --cov-report=term-missing
    --strict-markers
markers =
    unit: Unit tests
    integration: Integration tests
    slow: Slow running tests
EOF
```

### 整合測試環境
```yaml
# docker-compose.test.yml
version: '3.8'

services:
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - .:/app
    environment:
      - ENVIRONMENT=testing
      - DATABASE_URL=postgresql://test_user:test_password@test-db:5432/test_db
      - REDIS_URL=redis://test-redis:6379/0
    depends_on:
      - test-db
      - test-redis
    command: pytest tests/ -v

  test-db:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: test_db
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
    tmpfs:
      - /var/lib/postgresql/data

  test-redis:
    image: redis:6-alpine
    tmpfs:
      - /data
```

## 生產環境配置

### 系統配置

#### 1. 系統優化
```bash
# 核心參數調整
echo 'vm.max_map_count=262144' >> /etc/sysctl.conf
echo 'fs.file-max=65536' >> /etc/sysctl.conf
sysctl -p

# 設置 ulimit
echo '* soft nofile 65536' >> /etc/security/limits.conf
echo '* hard nofile 65536' >> /etc/security/limits.conf
```

#### 2. 防火牆配置
```bash
# UFW 設置
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow from 10.0.0.0/8 to any port 5432  # PostgreSQL (內部網路)
ufw enable
```

#### 3. 時間同步
```bash
# 安裝並配置 NTP
apt-get install ntp
systemctl enable ntp
systemctl start ntp
```

### 應用配置

#### 環境變數配置
```bash
# /etc/environment
ENVIRONMENT=production
DEBUG=false
SECRET_KEY=your-super-secret-key-here
DATABASE_URL=postgresql://prod_user:strong_password@localhost:5432/bee_swarm_prod
REDIS_URL=redis://localhost:6379/0
ALLOWED_HOSTS=your-domain.com,api.your-domain.com
```

#### Systemd 服務配置
```ini
# /etc/systemd/system/bee-swarm.service
[Unit]
Description=Bee Swarm API Server
After=network.target postgresql.service redis.service

[Service]
Type=notify
User=bee-swarm
Group=bee-swarm
WorkingDirectory=/opt/bee-swarm
ExecStart=/opt/bee-swarm/venv/bin/gunicorn main:app \
    --bind 0.0.0.0:8000 \
    --workers 4 \
    --worker-class uvicorn.workers.UvicornWorker \
    --timeout 120 \
    --keep-alive 5 \
    --max-requests 1000 \
    --max-requests-jitter 100
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=5

Environment=PYTHONPATH=/opt/bee-swarm
EnvironmentFile=/opt/bee-swarm/.env

[Install]
WantedBy=multi-user.target
```

## 環境變數配置

### 環境變數清單

#### 核心配置
```bash
# 應用配置
ENVIRONMENT=development|testing|production
DEBUG=true|false
SECRET_KEY=your-secret-key
LOG_LEVEL=DEBUG|INFO|WARNING|ERROR

# 資料庫配置
DATABASE_URL=postgresql://user:password@host:port/database
REDIS_URL=redis://host:port/db

# 安全配置
ALLOWED_HOSTS=localhost,127.0.0.1,your-domain.com
CORS_ORIGINS=http://localhost:3000,https://your-frontend.com

# GitHub 整合
GITHUB_TOKEN=your-github-token
GITHUB_WEBHOOK_SECRET=your-webhook-secret

# 模擬器配置
SIMULATION_MAX_WORKERS=4
SIMULATION_TIMEOUT=3600
RESULTS_STORAGE_PATH=/var/lib/bee-swarm/results
```

#### 環境特定配置

**開發環境 (.env.development)**
```bash
ENVIRONMENT=development
DEBUG=true
DATABASE_URL=postgresql://dev_user:dev_password@localhost:5432/bee_swarm_dev
REDIS_URL=redis://localhost:6379/0
LOG_LEVEL=DEBUG
ALLOWED_HOSTS=localhost,127.0.0.1
CORS_ORIGINS=http://localhost:3000
```

**測試環境 (.env.testing)**
```bash
ENVIRONMENT=testing
DEBUG=false
DATABASE_URL=postgresql://test_user:test_password@localhost:5432/bee_swarm_test
REDIS_URL=redis://localhost:6379/1
LOG_LEVEL=INFO
SIMULATION_MAX_WORKERS=2
```

**生產環境 (.env.production)**
```bash
ENVIRONMENT=production
DEBUG=false
DATABASE_URL=postgresql://prod_user:strong_password@db-server:5432/bee_swarm_prod
REDIS_URL=redis://redis-server:6379/0
LOG_LEVEL=WARNING
ALLOWED_HOSTS=api.yourdomain.com
CORS_ORIGINS=https://yourdomain.com
```

## 依賴項管理

### Python 依賴項

#### requirements.txt
```text
# 核心框架
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0

# 模擬器
simpy==4.0.1
numpy==1.24.3
pandas==2.0.3
matplotlib==3.7.2
seaborn==0.12.2

# 資料庫
sqlalchemy==2.0.23
asyncpg==0.29.0
alembic==1.12.1

# 快取
redis==5.0.1

# GitHub API
pygithub==1.59.1
requests==2.31.0

# 工具
python-dotenv==1.0.0
click==8.1.7
rich==13.7.0
```

#### requirements-dev.txt
```text
# 測試
pytest==7.4.3
pytest-cov==4.1.0
pytest-mock==3.12.0
pytest-asyncio==0.21.1

# 代碼品質
black==23.11.0
isort==5.12.0
flake8==6.1.0
mypy==1.7.1

# 開發工具
pre-commit==3.5.0
jupyter==1.0.0
ipython==8.17.2
```

### 依賴項安全性

#### 安全性掃描
```bash
# 安裝安全工具
pip install safety bandit

# 掃描已知漏洞
safety check

# 代碼安全性分析
bandit -r bee_swarm/
```

#### 依賴項更新策略
```bash
# 檢查過期依賴項
pip list --outdated

# 更新依賴項 (開發環境)
pip-review --auto

# 產生新的 requirements.txt
pip freeze > requirements-new.txt
```

## 網路與安全配置

### SSL/TLS 配置

#### Nginx 反向代理
```nginx
# /etc/nginx/sites-available/bee-swarm
server {
    listen 80;
    server_name api.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.yourdomain.com/privkey.pem;

    # SSL 配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 安全標頭
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 資料庫安全配置

#### PostgreSQL 配置
```sql
-- 建立專用使用者
CREATE USER bee_swarm_prod WITH PASSWORD 'strong_password';
CREATE DATABASE bee_swarm_prod OWNER bee_swarm_prod;

-- 設置權限
GRANT CONNECT ON DATABASE bee_swarm_prod TO bee_swarm_prod;
GRANT USAGE ON SCHEMA public TO bee_swarm_prod;
GRANT CREATE ON SCHEMA public TO bee_swarm_prod;
```

#### pg_hba.conf 配置
```text
# 只允許本地連線和特定 IP
local   bee_swarm_prod  bee_swarm_prod                md5
host    bee_swarm_prod  bee_swarm_prod  127.0.0.1/32  md5
host    bee_swarm_prod  bee_swarm_prod  10.0.0.0/8    md5
```

## 環境驗證

### 環境健康檢查腳本

#### check_environment.py
```python
#!/usr/bin/env python3
"""
環境驗證腳本
"""
import sys
import subprocess
import importlib
from pathlib import Path
from typing import List, Dict, Any

class EnvironmentChecker:
    def __init__(self):
        self.results: List[Dict[str, Any]] = []
    
    def check_python_version(self):
        """檢查 Python 版本"""
        version = sys.version_info
        required = (3, 8)
        
        if version >= required:
            self.results.append({
                "component": "Python",
                "status": "✅ PASS",
                "message": f"Version {version.major}.{version.minor}.{version.micro}"
            })
        else:
            self.results.append({
                "component": "Python",
                "status": "❌ FAIL",
                "message": f"Version {version.major}.{version.minor} < {required[0]}.{required[1]}"
            })
    
    def check_required_packages(self):
        """檢查必要的 Python 套件"""
        required_packages = [
            "fastapi", "uvicorn", "simpy", "pandas", 
            "numpy", "matplotlib", "sqlalchemy", "redis"
        ]
        
        for package in required_packages:
            try:
                importlib.import_module(package)
                self.results.append({
                    "component": f"Package: {package}",
                    "status": "✅ PASS",
                    "message": "Installed"
                })
            except ImportError:
                self.results.append({
                    "component": f"Package: {package}",
                    "status": "❌ FAIL",
                    "message": "Not installed"
                })
    
    def check_external_commands(self):
        """檢查外部命令"""
        commands = ["git", "docker", "docker-compose"]
        
        for cmd in commands:
            try:
                result = subprocess.run(
                    [cmd, "--version"], 
                    capture_output=True, 
                    text=True, 
                    timeout=10
                )
                if result.returncode == 0:
                    version = result.stdout.strip().split('\n')[0]
                    self.results.append({
                        "component": cmd.capitalize(),
                        "status": "✅ PASS",
                        "message": version
                    })
                else:
                    self.results.append({
                        "component": cmd.capitalize(),
                        "status": "❌ FAIL",
                        "message": "Command failed"
                    })
            except (subprocess.TimeoutExpired, FileNotFoundError):
                self.results.append({
                    "component": cmd.capitalize(),
                    "status": "❌ FAIL",
                    "message": "Not found"
                })
    
    def check_environment_variables(self):
        """檢查環境變數"""
        import os
        required_vars = ["ENVIRONMENT"]
        optional_vars = ["DATABASE_URL", "REDIS_URL", "SECRET_KEY"]
        
        for var in required_vars:
            if os.getenv(var):
                self.results.append({
                    "component": f"ENV: {var}",
                    "status": "✅ PASS",
                    "message": "Set"
                })
            else:
                self.results.append({
                    "component": f"ENV: {var}",
                    "status": "❌ FAIL",
                    "message": "Not set"
                })
        
        for var in optional_vars:
            if os.getenv(var):
                self.results.append({
                    "component": f"ENV: {var}",
                    "status": "⚠️ OPTIONAL",
                    "message": "Set"
                })
            else:
                self.results.append({
                    "component": f"ENV: {var}",
                    "status": "⚠️ OPTIONAL",
                    "message": "Not set"
                })
    
    def check_file_permissions(self):
        """檢查檔案權限"""
        files_to_check = [
            "scripts/role-management.sh",
            "docs/05-模擬工具/scripts/basic_simulation.py"
        ]
        
        for file_path in files_to_check:
            path = Path(file_path)
            if path.exists():
                if path.stat().st_mode & 0o111:  # 檢查執行權限
                    self.results.append({
                        "component": f"File: {file_path}",
                        "status": "✅ PASS",
                        "message": "Executable"
                    })
                else:
                    self.results.append({
                        "component": f"File: {file_path}",
                        "status": "⚠️ WARNING",
                        "message": "Not executable"
                    })
            else:
                self.results.append({
                    "component": f"File: {file_path}",
                    "status": "❌ FAIL",
                    "message": "Not found"
                })
    
    def run_all_checks(self):
        """執行所有檢查"""
        print("🔍 執行環境驗證...")
        print("=" * 50)
        
        self.check_python_version()
        self.check_required_packages()
        self.check_external_commands()
        self.check_environment_variables()
        self.check_file_permissions()
        
        # 輸出結果
        failed_count = 0
        warning_count = 0
        
        for result in self.results:
            print(f"{result['status']} {result['component']}: {result['message']}")
            
            if "FAIL" in result['status']:
                failed_count += 1
            elif "WARNING" in result['status']:
                warning_count += 1
        
        print("=" * 50)
        print(f"總結: {len(self.results)} 項檢查")
        print(f"  ✅ 通過: {len(self.results) - failed_count - warning_count}")
        print(f"  ⚠️  警告: {warning_count}")
        print(f"  ❌ 失敗: {failed_count}")
        
        if failed_count == 0:
            print("🎉 環境配置完整！")
            return True
        else:
            print("💥 環境配置有問題，請檢查失敗項目")
            return False

if __name__ == "__main__":
    checker = EnvironmentChecker()
    success = checker.run_all_checks()
    sys.exit(0 if success else 1)
```

### 使用環境驗證

```bash
# 執行環境檢查
python check_environment.py

# 或者使用 make 指令
make check-environment

# Docker 環境檢查
docker-compose -f docker-compose.dev.yml run --rm bee-swarm-api python check_environment.py
```

## 疑難排解

### 常見問題

#### 1. Python 虛擬環境問題
```bash
# 問題：無法建立虛擬環境
# 解決方案：
sudo apt-get install python3-venv python3-pip

# 問題：pip 版本過舊
# 解決方案：
python -m pip install --upgrade pip
```

#### 2. Docker 權限問題
```bash
# 問題：Docker 需要 sudo
# 解決方案：
sudo usermod -aG docker $USER
newgrp docker
```

#### 3. 埠號衝突
```bash
# 檢查埠號使用狀況
netstat -tlnp | grep :8000

# 停止衝突的服務
sudo systemctl stop nginx
```

### 支援資源

- **官方文檔**: [項目 GitHub Repository](https://github.com/your-org/bee-swarm)
- **故障排除**: 參見 [故障排除.md](故障排除.md)
- **社群支援**: GitHub Issues 和 Discussions
- **技術支援**: tech-support@your-org.com

---

*本文檔會隨著項目發展持續更新。如有疑問或建議，請透過 GitHub Issues 回報。* 